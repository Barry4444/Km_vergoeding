**************************************
 * Filou Oostende – Kilometervergoeding
 * Server-script (Apps Script) – Code.gs
 * Synoniemen voor Config, mail-log, bundelmail
 ***************************************/

const DEFAULTS = {
  SHEET_RITTEN: 'Ritten',
  SHEET_CONFIG: 'Config',
  SHEET_MAILLOG: 'MailLog',
  TARIEF_EURKM: 0.4309,
  STAFF_VALIDATORS: 'johan.dedrie@gmail.com',
  MAIL_BETALER: 'kgebbert@filou-oostende.be',
  MAIL_DEBUG_COPY: '',     // optioneel BCC voor debug
  STAFF_KEY: '0000-0000',
  WEBAPP_BASE: ' https://script.google.com/macros/s/AKfycbzeJgFMsy4wuRLJOmIQbPxncvelfjOf52v9tn0Eo7wimxNTJvjyUvh2xYN9E8y-ca9E/exec'     // zet je /exec hier of in Config
};

const REDEN_OPTS = ['Wedstrijd', 'Tornooi'];
const PLOEG_OPTS = ['U21','U18','U16','U14','Dames','N/A'];

const HEADERS = [
  'id','ts','status','rit_datum','afstand_km','bedrag_eur',
  'bestemming','ploeg','reden','coach_naam','gebruiker_email',
  'diverse_omschrijving','diverse_bedrag',
  'digest_mailed',
  'approved_at','approved_by',
  'paid_at','paid_by',
  'notes'
];

const ST = { NEW:'NIEUW', OK:'GOEDGEKEURD', NO:'AFGEKEURD', PAID:'BETAALD' };

/* ===== Utils ===== */
const _cache = {};
function cfg(key, fallback){ if (_cache[key]!==undefined) return _cache[key];
  const def = (DEFAULTS.hasOwnProperty(key)?DEFAULTS[key]:fallback);
  try{
    const sh = getOrCreateSheet(DEFAULTS.SHEET_CONFIG, []);
    const data = sh.getDataRange().getValues();
    for (let i=0;i<data.length;i++){ const k=String(data[i][0]||'').trim(); if(!k)continue; _cache[k]=data[i][1]; }
  }catch(e){}
  if (_cache[key]===undefined) _cache[key]=def;
  return _cache[key];
}
function getOrCreateSheet(name, headers){
  const ss=SpreadsheetApp.getActive(); let sh=ss.getSheetByName(name);
  if(!sh) sh=ss.insertSheet(name);
  if(headers && headers.length){
    const first = sh.getRange(1,1,1,headers.length).getValues()[0];
    const ok = headers.every((h,i)=> (first[i]||'').toString().trim().toLowerCase()===h.toLowerCase());
    if(!ok){ sh.clear(); sh.getRange(1,1,1,headers.length).setValues([headers]); sh.setFrozenRows(1); }
  }
  return sh;
}
function colIndexMap(){ const m={}; HEADERS.forEach((h,i)=>m[h]=i+1); return m; }
function toNumber(n){ const s=String(n??'').replace(',', '.').trim(); const x=Number(s); return isFinite(x)?x:0; }
function euro(n){ return '€ ' + (Math.round(n*100)/100).toFixed(2); }
function nowISO(){ return Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss'); }
function uuid(){ return Utilities.getUuid(); }
function lockGuard(fn){ return function(...args){ const lock=LockService.getScriptLock(); lock.waitLock(10000); try{ return fn.apply(this,args); } finally{ lock.releaseLock(); } }; }
function baseUrl(){ return String(cfg('WEBAPP_BASE', DEFAULTS.WEBAPP_BASE)||''); }
function staffAllowed(e){ const key=String((e&&e.parameter&&e.parameter.key)||''); const need=String(cfg('STAFF_KEY', DEFAULTS.STAFF_KEY)||''); return need&&key&&key===need; }

/* === Config-synoniemen === */
function getTarief(){
  const keys = ['TARIEF_EURKM','TARIEF-EURKM','KILOMETERTARIEF'];
  for (const k of keys){
    const raw = cfg(k, '');
    if (raw !== '' && raw != null){
      const v = toNumber(raw);
      if (v>0) return v;
    }
  }
  return DEFAULTS.TARIEF_EURKM;
}
function listFromCfg(keys, fallbackCsv){
  for (const k of keys){
    const raw = String(cfg(k,'')||'').trim();
    if (raw) return raw.split(/[,\s;]+/).map(s=>s.toLowerCase()).filter(Boolean);
  }
  return (fallbackCsv||'').split(/[,\s;]+/).map(s=>s.toLowerCase()).filter(Boolean);
}
function isValidator(email){
  const fallback = String(cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER)||'');
  const list = listFromCfg(['STAFF_VALIDATORS','VALIDATOR_EMAILS'], fallback);
  return list.includes(String(email||'').toLowerCase());
}
function isPayer(email){
  const fallback = String(cfg('MAIL_BETALER', DEFAULTS.MAIL_BETALER)||'');
  const list = listFromCfg(['STAFF_PAYERS','PAYOR_EMAILS'], fallback);
  return list.includes(String(email||'').toLowerCase());
}

/* ===== Mail logging + safe send ===== */
function logMail(entry){ // {to,subject,ok,error,context}
  const sh = getOrCreateSheet(cfg('SHEET_MAILLOG', DEFAULTS.SHEET_MAILLOG), ['ts','to','subject','ok','error','context']);
  sh.appendRow([ nowISO(), entry.to||'', entry.subject||'', entry.ok?'OK':'FAIL', entry.error||'', entry.context||'' ]);
}
function mailSafe(to, subject, body, options){
  const debugCopy = String(cfg('MAIL_DEBUG_COPY', DEFAULTS.MAIL_DEBUG_COPY)||'').trim();
  let res={ok:false,error:''};
  try{
    MailApp.sendEmail({ to, subject, htmlBody: body, bcc: debugCopy, noReply:true, name:'Ritten – Filou Oostende', ...(options||{}) });
    res.ok=true;
  }catch(e1){
    res.ok=false; res.error=String(e1);
    try{ // fallback
      const draft = GmailApp.createDraft(to, subject, '', {htmlBody:body, bcc:debugCopy, ...(options||{})}); draft.send(); res.ok=true;
    }catch(e2){ res.ok=false; res.error = (res.error?res.error+' | ':'')+'GmailApp->'+String(e2); }
  }
  logMail({to,subject,ok:res.ok,error:res.error,context:(options&&options.context)||''});
  return res;
}

/* ===== Data ===== */
const appendRit = lockGuard(function (p){
  const sh = getOrCreateSheet(cfg('SHEET_RITTEN', DEFAULTS.SHEET_RITTEN), HEADERS);
  const C = colIndexMap();

  const reden = String(p.reden||'').trim();
  const ploeg = String(p.ploeg||'').trim();
  if (!REDEN_OPTS.includes(reden)) throw new Error('Ongeldige reden');
  if (!PLOEG_OPTS.includes(ploeg)) throw new Error('Ongeldige ploeg');

  const km = toNumber(p.afstand_km);
  const tarief = getTarief();
  const bedrag = Math.round(km * tarief * 100)/100;

  const row = [];
  row[C.id-1]=uuid(); row[C.ts-1]=nowISO(); row[C.status-1]=ST.NEW;
  row[C.rit_datum-1]=String(p.rit_datum||''); row[C.afstand_km-1]=km; row[C.bedrag_eur-1]=bedrag;
  row[C.bestemming-1]=String(p.bestemming||''); row[C.ploeg-1]=ploeg; row[C.reden-1]=reden;
  row[C.coach_naam-1]=String(p.coach_naam||''); row[C.gebruiker_email-1]=String(p.gebruiker_email||'');
  row[C.diverse_omschrijving-1]=String(p.diverse_omschrijving||''); row[C.diverse_bedrag-1]=toNumber(p.diverse_bedrag||0);
  row[C.digest_mailed-1]=''; row[C.approved_at-1]=''; row[C.approved_by-1]=''; row[C.paid_at-1]=''; row[C.paid_by-1]=''; row[C.notes-1]='';
  sh.appendRow(row);

  const saved = sh.getRange(sh.getLastRow(),1,1,HEADERS.length).getValues()[0];
  const o={}; HEADERS.forEach((h,i)=>o[h]=saved[i]); return o;
});
function colIndexMap(){ const m={}; HEADERS.forEach((h,i)=>m[h]=i+1); return m; }
function getAll(){ const sh=getOrCreateSheet(cfg('SHEET_RITTEN', DEFAULTS.SHEET_RITTEN), HEADERS); const data=sh.getDataRange().getValues(); const out=[];
  for(let r=2;r<=data.length;r++){ const row=data[r-1]; if(!row||!row[0])continue; const o={}; HEADERS.forEach((h,i)=>o[h]=row[i]); out.push(o);} return out;}
function findById(id){ const sh=getOrCreateSheet(cfg('SHEET_RITTEN', DEFAULTS.SHEET_RITTEN), HEADERS); const data=sh.getDataRange().getValues(); const C=colIndexMap();
  for(let r=2;r<=data.length;r++){ if(String(data[r-1][C['id']-1])===id) return {rowIndex:r,row:data[r-1]}; } return null;}
function updateRow(rIndex,obj){ const sh=getOrCreateSheet(cfg('SHEET_RITTEN', DEFAULTS.SHEET_RITTEN), HEADERS); const row=sh.getRange(rIndex,1,1,HEADERS.length).getValues()[0];
  HEADERS.forEach((h,i)=>{ if(obj.hasOwnProperty(h)) row[i]=obj[h]; }); sh.getRange(rIndex,1,1,HEADERS.length).setValues([row]); }

/* ===== Mails ===== */
function mailOnApprove(o){
  const betaler  = String(cfg('MAIL_BETALER', DEFAULTS.MAIL_BETALER)||'').trim();
  const validator= String(cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER)||'').trim();
  const aanvr    = String(o['gebruiker_email']||'').trim();
  const tarief   = getTarief();
  const bedragStr= euro(toNumber(o['bedrag_eur']));
  const extraStr = euro(toNumber(o['diverse_bedrag']||0));
  const paidLink = (baseUrl() && cfg('STAFF_KEY','')) ? `${baseUrl()}?action=paid&id=${encodeURIComponent(o.id)}&key=${encodeURIComponent(cfg('STAFF_KEY',''))}` : '';

  const details = [
    `<b>ID:</b> ${o.id}`,
    `<b>Coach:</b> ${o.coach_naam || '-'}`,
    `<b>Ploeg:</b> ${o.ploeg} — <b>Reden:</b> ${o.reden}`,
    `<b>Bestemming:</b> ${o.bestemming}`,
    `<b>Datum:</b> ${o.rit_datum}`,
    `<b>Afstand (heen & terug):</b> ${Number(o.afstand_km).toFixed(2)} km`,
    `<b>Tarief:</b> € ${tarief.toFixed(4)} / km`,
    `<b>Bedrag km:</b> ${bedragStr}`,
    `<b>Diverse kosten:</b> ${extraStr} — ${o.diverse_omschrijving || '-'}`,
  ].join('<br>');
  const subj = `[Filou] Betaalopdracht – ${o.ploeg} ${o.reden} – ${bedragStr}`;
  const body = [`<b>Betaalopdracht</b> (goedgekeurd)`, '', details, (paidLink?`<br><br>💶 <a href="${paidLink}">Markeer als betaald</a>`:'')].join('<br>');

  const r1 = betaler   ? mailSafe(betaler, subj, body, {context:'approve→betaler'})   : {ok:false,error:'MAIL_BETALER leeg'};
  const r2 = validator ? mailSafe(validator, '[Kopie] '+subj, body, {context:'approve→validator'}) : {ok:false,error:'MAIL_VALIDEERDER leeg'};
  const r3 = aanvr     ? mailSafe(aanvr, `[Filou] Aanvraag in behandeling genomen (ID ${o.id})`, `Beste,<br><br>Je aanvraag werd <b>goedgekeurd</b> en doorgestuurd ter betaling.<br><br>${details}`, {context:'approve→aanvrager'}) : {ok:true};
  return {betaler:r1, validator:r2, aanvrager:r3};
}
function mailRejected(o){
  const aanvr = String(o['gebruiker_email']||'').trim(); if(!aanvr) return {ok:true};
  return mailSafe(aanvr, `[Filou] Aanvraag afgekeurd (ID ${o.id})`,
    `Beste,<br><br>Jammer, je aanvraag werd <b>afgekeurd</b> door de validator.<br><br>
     <b>ID:</b> ${o.id}<br><b>Coach:</b> ${o.coach_naam || '-'}<br><b>Ploeg:</b> ${o.ploeg}<br><b>Bestemming:</b> ${o.bestemming}<br><b>Datum:</b> ${o.rit_datum}`,
    {context:'reject→aanvrager'});
}
function mailPaid(o){
  const aanvr = String(o['gebruiker_email']||'').trim(); if(!aanvr) return {ok:true};
  return mailSafe(aanvr, `[Filou] Betaling uitgevoerd (ID ${o.id})`,
    `Beste,<br><br>Je aanvraag werd <b>betaald</b>.<br><br><b>Bedrag km:</b> ${euro(toNumber(o['bedrag_eur']))}<br><b>Diverse kosten:</b> ${euro(toNumber(o['diverse_bedrag']||0))}`,
    {context:'paid→aanvrager'});
}

/*** === PATCH: helpers voor autorisatie & snelle mailtest === ***/

// 1) éénmalig draaien via Run om Gmail/Drive/Spreadsheet scopes te accepteren
function authWarmup() {
  MailApp.getRemainingDailyQuota();
  GmailApp.getAliases();
  DriveApp.getRootFolder();
  SpreadsheetApp.getActive();
  return 'OK';
}

// 2) snelle probe: stuurt een mail naar MAIL_VALIDEERDER uit je Config
//    Gebruik: …/exec?action=mailprobe&key=JOUW-KEY
function _route_mailprobe_(e) {
  const to = String(cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER) || '').trim();
  if (!to) return HtmlService.createHtmlOutput('<p>MAIL_VALIDEERDER leeg in Config.</p>');
  const r = mailSafe(to, '[Filou] Probe naar valideerder', 'Dit is een probe vanuit de webapp.', {context:'mailprobe→valideerder'});
  const msg = r.ok ? `OK → ${to}` : `FAILED → ${to} — ${r.error}`;
  return HtmlService.createHtmlOutput(`<p>${msg}</p><p><a href="?action=maillog&key=${encodeURIComponent(e.parameter.key)}">MailLog</a></p>`);
}

/* ===== Export ===== */
function exportCSV_(){
  const rows = getAll(); const header = HEADERS.join(',');
  const toCsv = v => `"${String(v===undefined||v===null?'':v).replace(/"/g,'""')}"`;
  const csv = [header].concat(rows.map(r => HEADERS.map(h=>toCsv(r[h])).join(','))).join('\r\n');
  const blob = Utilities.newBlob(csv, 'text/csv', 'ritten-export.csv');
  const file = DriveApp.createFile(blob).setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return { csvUrl: file.getUrl(), fileId: file.getId() };
}

/* ===== Routes ===== */
function doPost(e){
  try{
    const p = e && e.parameter ? e.parameter : {};
    const saved = appendRit(p);

    if (String(cfg('MAIL_ON_POST','false')).toLowerCase()==='true'){
      const to = String(cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER));
      mailSafe(to, `[Filou] Nieuwe aanvraag – ${saved.ploeg} ${saved.reden}`,
        `Nieuwe rit:<br><br><b>ID:</b> ${saved.id}<br><b>Ploeg:</b> ${saved.ploeg}<br><b>Reden:</b> ${saved.reden}<br><b>Coach:</b> ${saved.coach_naam}<br><b>Bestemming:</b> ${saved.bestemming}<br><b>Datum:</b> ${saved.rit_datum}<br><b>Afstand:</b> ${saved.afstand_km} km<br><b>Bedrag km:</b> ${euro(saved.bedrag_eur)}`,
        {context:'post→valideerder'});
    }

    return ContentService.createTextOutput(JSON.stringify({ok:true, id:saved.id}))
      .setMimeType(ContentService.MimeType.JSON);
  }catch(err){
    return ContentService.createTextOutput(JSON.stringify({ok:false,error:String(err)}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e){
  const action = (e&&e.parameter&&e.parameter.action)?String(e.parameter.action):'';

  if (!action){
    return HtmlService.createHtmlOutput('<h2>Ritten-service actief</h2><pre>'+
      '?action=health\n?action=diag&key=...\n?action=dashboard&key=...\n?action=approve&id=...&key=...\n?action=reject&id=...&key=...\n?action=paid&id=...&key=...\n?action=export&key=...\n?action=senddigest&key=...\n?action=testmail&to=...&key=...\n?action=maillog&key=...\n</pre>');
  }

  if (action==='health'){
    return HtmlService.createHtmlOutput(
      `<h3>OK</h3>
       <p>Tarief: <b>€ ${getTarief().toFixed(4)}/km</b></p>
       <p>Valideerder: ${cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER)}</p>
       <p>Betaler: ${cfg('MAIL_BETALER', DEFAULTS.MAIL_BETALER)}</p>
       <p>WEBAPP_BASE: ${baseUrl()||'(niet gezet)'}</p>`
    );
  }

  // staff key
  if (!staffAllowed(e)){
    return HtmlService.createHtmlOutput('<h3>403</h3><p>Key ontbreekt of ongeldig. Voeg <code>&key=…</code> toe.</p>');
  }
  if (action === 'mailprobe') {
  return _route_mailprobe_(e);
 }


  if (action==='diag'){
    const who = Session.getActiveUser().getEmail() || '';
    const vOK = isValidator(who), pOK = isPayer(who);
    const k = encodeURIComponent(e.parameter.key);
    return HtmlService.createHtmlOutput(
      `<h2>Diagnose</h2>
       <table border="1" cellspacing="0" cellpadding="6">
        <tr><td><b>Tijd</b></td><td>${nowISO()}</td></tr>
        <tr><td><b>Ingelogd als (STAFF)</b></td><td>${who||'(onbekend)'}</td></tr>
        <tr><td><b>Rol – Validator</b></td><td style="color:${vOK?'green':'red'}">${vOK?'JA':'NEE'}</td></tr>
        <tr><td><b>Rol – Betaler</b></td><td style="color:${pOK?'green':'red'}">${pOK?'JA':'NEE'}</td></tr>
        <tr><td><b>Tarief</b></td><td>€ ${getTarief().toFixed(4)}/km</td></tr>
        <tr><td><b>WEBAPP_BASE</b></td><td>${baseUrl()||'(niet gezet)'}</td></tr>
       </table>
       <p>
        <a href="?action=dashboard&key=${k}">→ Dashboard</a> |
        <a href="?action=export&key=${k}">→ Export</a> |
        <a href="?action=senddigest&key=${k}">→ Bundelmail (nieuwe)</a> |
        <a href="?action=testmail&to=${encodeURIComponent(cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER))}&key=${k}">→ Testmail valideerder</a> |
        <a href="?action=maillog&key=${k}">→ MailLog</a>
       </p>`
    );
  }

  if (action==='testmail'){
    const to = String(e.parameter.to||cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER));
    const r = mailSafe(to, '[Filou] Testmail – rittenservice', 'Dit is een testmail.', {context:'testmail'});
    return HtmlService.createHtmlOutput(r.ok?`<p>OK → ${to}</p>`:`<p>FAILED → ${to}<br>${r.error}</p>`);
  }

  if (action==='maillog'){
    const sh = getOrCreateSheet(cfg('SHEET_MAILLOG', DEFAULTS.SHEET_MAILLOG), ['ts','to','subject','ok','error','context']);
    const data = sh.getDataRange().getValues(); data.shift();
    let html = '<h2>MailLog</h2><table border="1" cellspacing="0" cellpadding="6"><tr><th>ts</th><th>to</th><th>subject</th><th>ok</th><th>error</th><th>context</th></tr>';
    data.slice(-100).reverse().forEach(r=>{ html += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`; });
    html += '</table>'; return HtmlService.createHtmlOutput(html);
  }

  if (action==='dashboard'){
    const who = Session.getActiveUser().getEmail() || '';
    if (!isValidator(who) && !isPayer(who))
      return HtmlService.createHtmlOutput('<h3>403</h3><p>Uw e-mail staat niet in STAFF_VALIDATORS/VALIDATOR_EMAILS of STAFF_PAYERS/PAYOR_EMAILS.</p>');

    const rows = getAll().reverse();
    const k = encodeURIComponent(e.parameter.key);
    let t = `<h2>Dashboard</h2>
             <p><b>Betaler:</b> ${cfg('MAIL_BETALER', DEFAULTS.MAIL_BETALER)} — <b>Valideerder:</b> ${cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER)}</p>
             <p><a href="?action=senddigest&key=${k}">Bundelmail (NIEUW)</a> | <a href="?action=maillog&key=${k}">MailLog</a></p>
             <table border="1" cellspacing="0" cellpadding="6">
             <tr><th>Status</th><th>ID</th><th>Datum</th><th>Ploeg</th><th>Reden</th><th>Coach</th><th>Bestemming</th><th>Kilometers</th><th>Bedrag</th><th>Extra (€)</th><th>Acties</th></tr>`;
    rows.forEach(r=>{
      const id=r.id, km=Number(r.afstand_km||0).toFixed(2), bedrag=euro(Number(r.bedrag_eur||0)), extra=euro(Number(r.diverse_bedrag||0));
      t += `<tr>
        <td>${r.status}</td><td><code>${id}</code></td><td>${r.rit_datum}</td><td>${r.ploeg}</td><td>${r.reden}</td>
        <td>${r.coach_naam||''}</td><td>${r.bestemming||''}</td>
        <td style="text-align:right">${km} km</td><td style="text-align:right">${bedrag}</td><td style="text-align:right">${extra}</td>
        <td><a href="?action=approve&id=${encodeURIComponent(id)}&key=${k}">✅</a> <a href="?action=reject&id=${encodeURIComponent(id)}&key=${k}">❌</a> <a href="?action=paid&id=${encodeURIComponent(id)}&key=${k}">💶</a></td>
      </tr>`;
    });
    t+='</table>'; return HtmlService.createHtmlOutput(t);
  }

  if (action==='approve' || action==='reject' || action==='paid'){
    const who = Session.getActiveUser().getEmail() || '';
    if (!isValidator(who) && !isPayer(who))
      return HtmlService.createHtmlOutput('<h3>403</h3><p>Uw e-mail staat niet in STAFF_VALIDATORS/VALIDATOR_EMAILS of STAFF_PAYERS/PAYOR_EMAILS.</p>');

    const id = String(e.parameter.id||''); const found = findById(id);
    if (!found) return HtmlService.createHtmlOutput(`<p>Niet gevonden: ${id}</p>`);
    const o={}; HEADERS.forEach((h,i)=>o[h]=found.row[i]);
    const k = encodeURIComponent(e.parameter.key);

    if (action==='approve'){
      o.status=ST.OK; o.approved_at=nowISO(); o.approved_by=who||'validator'; updateRow(found.rowIndex,o);
      const r = mailOnApprove(o);
      return HtmlService.createHtmlOutput(
        `<p>✅ Goedgekeurd.</p>
         <ul>
           <li>Betaler: <b>${r.betaler.ok?'OK':'FAILED'}</b> ${r.betaler.error?('— '+r.betaler.error):''}</li>
           <li>Valideerder (kopie): <b>${r.validator.ok?'OK':'FAILED'}</b> ${r.validator.error?('— '+r.validator.error):''}</li>
           <li>Aanvrager: <b>${r.aanvrager.ok?'OK':'FAILED'}</b> ${r.aanvrager.error?('— '+r.aanvrager.error):''}</li>
         </ul>
         <p><a href="?action=maillog&key=${k}">MailLog</a> — <a href="?action=dashboard&key=${k}">Terug</a></p>`
      );
    }
    if (action==='reject'){
      o.status=ST.NO; updateRow(found.rowIndex,o);
      const r = mailRejected(o);
      return HtmlService.createHtmlOutput(`<p>❌ Afgekeurd. Mail aanvrager: <b>${r.ok?'OK':'FAILED'}</b> ${r.error?('— '+r.error):''}
        <br><a href="?action=maillog&key=${k}">MailLog</a> — <a href="?action=dashboard&key=${k}">Terug</a></p>`);
    }
    if (action==='paid'){
      o.status=ST.PAID; o.paid_at=nowISO(); o.paid_by=who||'betaler'; updateRow(found.rowIndex,o);
      const r = mailPaid(o);
      return HtmlService.createHtmlOutput(`<p>💶 Betaald. Mail aanvrager: <b>${r.ok?'OK':'FAILED'}</b> ${r.error?('— '+r.error):''}
        <br><a href="?action=maillog&key=${k}">MailLog</a> — <a href="?action=dashboard&key=${k}">Terug</a></p>`);
    }
  }

  if (action==='export'){
    const x = exportCSV_();
    return HtmlService.createHtmlOutput(`<h3>Export klaar</h3><p><a href="${x.csvUrl}" target="_blank">Download CSV</a></p>`);
  }

  if (action==='senddigest'){
    const sh = getOrCreateSheet(cfg('SHEET_RITTEN', DEFAULTS.SHEET_RITTEN), HEADERS);
    const C = colIndexMap();
    const data = sh.getDataRange().getValues();
    const idx = [];
    for (let r=2;r<=data.length;r++){
      const row = data[r-1];
      if (row[C['status']-1]===ST.NEW && !row[C['digest_mailed']-1]) idx.push(r);
    }
    if (!idx.length) return HtmlService.createHtmlOutput('<p>Geen nieuwe aanvragen om te bundelen.</p>');

    const to = String(cfg('MAIL_VALIDEERDER', DEFAULTS.MAIL_VALIDEERDER));
    let body = `<b>Bundel nieuwe aanvragen (${idx.length})</b><br><br>`;
    idx.forEach(r=>{
      const row = sh.getRange(r,1,1,HEADERS.length).getValues()[0];
      const o={}; HEADERS.forEach((h,i)=>o[h]=row[i]);
      body += `<div style="margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:6px">
        <b>ID:</b> ${o.id} — <b>${o.ploeg} ${o.reden}</b><br>
        <b>Coach:</b> ${o.coach_naam || '-'}<br>
        <b>Bestemming:</b> ${o.bestemming} — <b>Datum:</b> ${o.rit_datum}<br>
        <b>Afstand (heen & terug):</b> ${Number(o.afstand_km||0).toFixed(2)} km<br>
        <b>Bedrag km:</b> ${euro(Number(o.bedrag_eur||0))} — <b>Diverse:</b> ${euro(Number(o.diverse_bedrag||0))}
      </div>`;
    });

    const r = mailSafe(to, `[Filou] Bundel nieuwe aanvragen (${idx.length})`, body, {context:'senddigest→valideerder'});
    if (r.ok){
      idx.forEach(rn => sh.getRange(rn, C['digest_mailed'], 1, 1).setValue(nowISO()));
      return HtmlService.createHtmlOutput(`<p>Bundelmail verstuurd naar ${to} (${idx.length}). <a href="?action=maillog&key=${encodeURIComponent(e.parameter.key)}">MailLog</a></p>`);
    } else {
      return HtmlService.createHtmlOutput(`<p>Kon bundelmail niet versturen: ${r.error}. <a href="?action=maillog&key=${encodeURIComponent(e.parameter.key)}">MailLog</a></p>`);
    }
  }

  return HtmlService.createHtmlOutput('<p>Onbekende actie.</p>');
}


